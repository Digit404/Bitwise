<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrōmle</title>
    <link rel="shortcut icon" href="/res/favicon.png" type="image/png">
    <link href="https://unpkg.com/sanitize.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap&family=Matemasie&family=Noto+Color+Emoji');

        :root {
            --fun-font: "Matemasie", fantasy;
            --mono-font: "Fira Code", monospace;
            --countdown-font: "Permanent Marker", cursive;
            --emoji-font: "Segoe UI Emoji",
                "Noto Color Emoji",
                sans-serif;
            --transition-duration: 3s;
            --background-color: #000;
            --foreground-color: #fff;
            --container-bg: #1118;
            --container-backdrop: invert(1);
            --border-radius: 100vw;
            --btn-bg: #111a;
            --btn-hover-bg: #aa8;
            --btn-active-bg: #fff;
            --btn-active-color: #111;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--mono-font);
            background-color: var(--background-color);
            color: var(--foreground-color);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .title {
            font-size: 8vw;
            margin: 0;
            padding: 0.25ch 1ch .5ch 1ch;
            border-radius: 100vw;
            background: var(--container-bg);
            backdrop-filter: var(--container-backdrop);
            font-family: var(--fun-font);
            transition: scale var(--transition-duration) ease-in-out, transform var(--transition-duration) ease-in-out;
            user-select: none;
        }

        #main-title,
        #win-title {
            position: absolute;
            top: 15%;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            display: none;
        }

        #bg-left,
        #bg-right {
            position: fixed;
            top: 0;
            width: 50%;
            height: 100%;
            background-color: var(--background-color);
            z-index: -1;
        }

        #bg-left {
            left: 0;
        }

        #bg-right {
            right: 0;
        }

        @keyframes slap-in {

            0%,
            100% {
                opacity: 0;
            }

            10%,
            90% {
                opacity: 1;
            }

            0% {
                transform: translate(-50%, -50%) scale(4);
            }

            10%,
            90% {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .countdown {
            position: absolute;
            font-size: 5em;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--countdown-font);
            opacity: 0;
            animation: slap-in 800ms forwards;
            z-index: 2;
        }

        .button {
            font-size: 3em;
            padding: 20px 30px;
            border: none;
            border-radius: var(--border-radius);
            background: var(--btn-bg);
            backdrop-filter: var(--container-backdrop);
            color: var(--foreground-color);
            cursor: pointer;
            font-family: var(--mono-font);
            transition: background 0.3s;
        }

        .button:hover {
            background: var(--btn-hover-bg);
        }

        .button:active {
            background: var(--btn-active-bg);
            color: var(--btn-active-color);
        }

        #play-button,
        #play-again-button {
            position: absolute;
            top: 70%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #guess-button {
            margin-top: 50px;
        }

        #guess-box {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5rem;
            padding: 20px 30px;
            background: var(--btn-bg);
            backdrop-filter: var(--container-backdrop);
            color: var(--foreground-color);
            border-radius: 50px;
        }

        #guess-input {
            font-size: 1em;
            border: none;
            background: transparent;
            color: var(--foreground-color);
            font-family: monospace;
            text-transform: uppercase;
            resize: none;
        }

        #guess-input:focus {
            outline: none;
        }

        .invalid {
            background: #f11a;
        }

        #diff-display {
            font-size: 3rem;
            position: absolute;
            font-family: var(--emoji-font);
            top: 20%;
        }

        #score {
            position: absolute;
            font-size: 3rem;
            bottom: 10%;
            background-color: var(--btn-bg);
            backdrop-filter: var(--container-backdrop);
            padding: 10px 20px;
            border-radius: var(--border-radius);
        }

        label {
            font-size: 2rem;
            color: var(--foreground-color);
            backdrop-filter: var(--container-backdrop);
            background-color: var(--container-bg);
            position: absolute;
            top: 90%;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        input[type="checkbox"] {
            display: none;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            background-color: #444;
            border: 2px solid #fff;
            border-radius: 4px;
            display: inline-block;
            position: relative;
            margin-right: 10px;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        input[type="checkbox"]:not(:checked)+.checkbox::before {
            content: '';
            position: absolute;
            top: 6px;
            left: 6px;
            width: 12px;
            height: 12px;
            background-color: transparent;
            border: 2px solid transparent;
            border-radius: 2px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        input[type="checkbox"]:checked+.checkbox {
            background-color: #f90;
            border-color: #f90;
        }

        input[type="checkbox"]:checked+.checkbox::before {
            background-color: #fff;
            border-color: #f90;
        }

        @media (max-width: 600px) {
            .title {
                font-size: 12vw;
            }

            #guess-box {
                font-size: 3rem;
            }

            #diff-display {
                font-size: 2rem;
            }

            .button {
                font-size: 2em;
                padding: 10px 20px;
            }
        }
    </style>
</head>

<body>
    <div id="bg-left"></div>
    <div id="bg-right"></div>
    <div class="screen" id="start-screen" style="display: flex;">
        <h1 class="title" id="main-title">Chrōmle</h1>
        <button class="button" id="play-button">Start</button>
        <label for="hard-mode">
            <input type="checkbox" id="hard-mode">
            <span class="checkbox"></span>
            Hard Mode
        </label>
    </div>
    <div class="screen" id="game-screen">
        <span id="guess-box">#<textarea id="guess-input" rows="1" cols="6" maxlength="6"></textarea></span>
        <button class="button" id="guess-button">Guess</button>
        <div id="diff-display" hidden></div>
    </div>
    <div class="screen" id="end-screen">
        <h1 class="title" id="win-title">You Win!</h1>
        <div id="score"></div>
        <button class="button" id="play-again-button">Start Again</button>
    </div>
    <script>
        const elements = {
            mainTitle: document.getElementById('main-title'),
            bgLeft: document.getElementById('bg-left'),
            bgRight: document.getElementById('bg-right'),
            startScreen: document.getElementById('start-screen'),
            gameScreen: document.getElementById('game-screen'),
            guessButton: document.getElementById('guess-button'),
            diffDisplay: document.getElementById('diff-display'),
            guessInput: document.getElementById('guess-input'),
            guessBox: document.getElementById('guess-box'),
            endScreen: document.getElementById('end-screen'),
            winTitle: document.getElementById('win-title'),
            playAgainButton: document.getElementById('play-again-button'),
            playButton: document.getElementById('play-button')
        };

        let guesses = [];
        let flashingInterval;

        function getRandomColor() {
            const hex = Math.floor(Math.random() * 16777216).toString(16).padStart(6, '0');
            return '#' + hex;
        }

        function getRandomHalfColor() {
            const hex = Math.floor(Math.random() * 4096).toString(16).padStart(3, '0');
            const doubledHex = hex.split('').map(char => char + char).join('');
            return '#' + doubledHex;
        }

        function getRandomHue() {
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 100%, 50%)`;
        }

        function flashBackground(element) {
            const { bgLeft, bgRight } = elements;
            bgLeft.style.transition = 'background-color 3s linear';
            bgRight.style.transition = 'background-color 3s linear';
            bgLeft.style.backgroundColor = getRandomHue();
            bgRight.style.backgroundColor = getRandomHue();
            element.style.scale = Math.random() * 0.5 + 1;
            element.style.transform = `rotate(${Math.random() * 10 - 5}deg)`;
        }

        function startFlashingBackground(element) {
            clearInterval(flashingInterval);
            flashingInterval = setInterval(() => flashBackground(element), 3000);
            setTimeout(() => flashBackground(element), 50);
        }

        // Initial call to start flashing at the beginning
        startFlashingBackground(elements.mainTitle);

        function colorCodeToValue(color) {
            const hex = color.replace('#', '');
            if (hex.length === 3) {
                return {
                    r: parseInt(hex[0] + hex[0], 16),
                    g: parseInt(hex[1] + hex[1], 16),
                    b: parseInt(hex[2] + hex[2], 16)
                };
            }
            return {
                r: parseInt(hex.slice(0, 2), 16),
                g: parseInt(hex.slice(2, 4), 16),
                b: parseInt(hex.slice(4, 6), 16)
            };
        }

        function compareColors(color1, color2) {
            return color1.r === color2.r && color1.g === color2.g && color1.b === color2.b;
        }

        function showCountdown(callback) {
            const numberDisplay = (i) => {
                if (i > 0) {
                    const number = document.createElement('div');
                    number.textContent = i;
                    number.classList.add('countdown');
                    document.body.appendChild(number);
                    setTimeout(() => {
                        number.remove();
                        numberDisplay(i - 1);
                    }, 800); // not actually a second
                } else {
                    const go = document.createElement('div');
                    go.textContent = 'Go!';
                    go.classList.add('countdown');
                    document.body.appendChild(go);
                    setTimeout(() => go.remove(), 800);
                    callback();
                }
            };
            numberDisplay(3);
        }

        elements.playButton.addEventListener('click', () => {
            const { bgLeft, bgRight, startScreen } = elements;
            bgLeft.style.transition = 'background-color 1s linear';
            bgRight.style.transition = 'background-color 1s linear';
            clearInterval(flashingInterval);
            bgLeft.style.backgroundColor = '#000';
            bgRight.style.backgroundColor = '#000';
            startScreen.style.display = 'none';
            showCountdown(startGame);
        });

        function startGame() {
            const { diffDisplay, guessInput, bgRight, gameScreen } = elements;
            const hardMode = document.getElementById('hard-mode').checked;
            diffDisplay.textContent = '';
            guessInput.value = '';
            guessInput.maxLength = hardMode ? 6 : 3;
            guessInput.cols = hardMode ? 6 : 3;

            const color = hardMode ? getRandomColor() : getRandomHalfColor();
            const colorValue = colorCodeToValue(color);

            bgRight.style.backgroundColor = color;
            gameScreen.style.display = 'flex';

            elements.guessButton.onclick = () => makeGuess(colorValue, color);
        }

        function makeGuess(colorValue, color) {
            const { diffDisplay, guessButton, guessInput, bgLeft } = elements;
            const guess = guessInput.value;

            // Validation for hex color input
            if (!/^[0-9A-F]{3}([0-9A-F]{3})?$/i.test(guess)) {
                guessButton.textContent = 'Invalid';
                guessButton.classList.add('invalid');
                setTimeout(() => {
                    guessButton.textContent = 'Guess';
                    guessButton.classList.remove('invalid');
                }, 1000);
                return;
            }

            bgLeft.style.backgroundColor = `#${guess}`;
            const guessValue = colorCodeToValue(`#${guess}`);
            guesses.push(guessValue);

            if (compareColors(guessValue, colorValue)) {
                win(color);
                return;
            }

            const diff = {
                r: colorValue.r - guessValue.r,
                g: colorValue.g - guessValue.g,
                b: colorValue.b - guessValue.b
            };

            diffDisplay.textContent = `${diff.r > 0 ? '⬆️' : diff.r < 0 ? '⬇️' : '🟩'} ${diff.g > 0 ? '⬆️' : diff.g < 0 ? '⬇️' : '🟩'} ${diff.b > 0 ? '⬆️' : diff.b < 0 ? '⬇️' : '🟩'}`;
            diffDisplay.hidden = false;
        }

        function win(color) {
            const { gameScreen, endScreen, winTitle } = elements;
            gameScreen.style.display = 'none';
            endScreen.style.display = 'flex';
            document.getElementById('score').textContent = `Score: ${guesses.length}`;
            startFlashingBackground(winTitle); // Use the same flashing function for the win screen

            elements.playAgainButton.onclick = () => {
                endScreen.style.display = 'none';
                elements.startScreen.style.display = 'flex';
                clearInterval(flashingInterval);
                startFlashingBackground(elements.mainTitle);
                guesses.length = 0; // Reset guesses for the new game
            };
        }
    </script>
</body>

</html>